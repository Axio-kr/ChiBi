<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D 모델</title>
    <!-- PIXI.js 라이브러리 포함 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.0.0/pixi.min.js"></script>
    <!-- Live2D 라이브러리 포함 -->
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@latest/dist/pixi-live2d-display.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        #canvas {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <script>
        const cubism4Model = "https://axio-kr.github.io/ChiBi/CHIBI.model3.json"; // 업로드된 모델 경로
        const live2d = PIXI.live2d;

        (async function main() {
            const app = new PIXI.Application({
                view: document.getElementById("canvas"),
                autoStart: true,
                resizeTo: window,
            });

            const backgroundImage = "https://axio-kr.github.io/ChiBi/img/2024.03.14-020336488.png"; // 업로드된 이미지 경로

            // 배경 이미지를 로드하고 스프라이트로 변환
            const backgroundTexture = await PIXI.Texture.fromURL(backgroundImage);
            const backgroundSprite = new PIXI.Sprite(backgroundTexture);

            // 스프라이트 크기를 화면 크기에 맞게 조정
            backgroundSprite.width = app.screen.width;
            backgroundSprite.height = app.screen.height;

            // 배경 스프라이트를 스테이지에 추가
            app.stage.addChild(backgroundSprite);

            // 리사이즈 이벤트에 맞춰 배경 크기를 조정
            window.addEventListener('resize', () => {
                backgroundSprite.width = app.screen.width;
                backgroundSprite.height = app.screen.height;
            });

            try {
                const model = await live2d.Live2DModel.from(cubism4Model);
                app.stage.addChild(model);

                // 모델 초기 위치를 화면 중앙으로 설정
                const initialScale = 0.5; // 필요한 초기 스케일 값을 설정합니다
                model.scale.set(initialScale);

                // 모델의 크기를 알기 위해 먼저 업데이트
                model.updateTransform();

                // 모델의 중심을 화면 중심에 맞추기
                model.x = (innerWidth / 2) - (model.width / 2);
                model.y = (innerHeight / 2) - (model.height / 2);

                window.wallpaperPropertyListener = {
                    applyUserProperties: function(properties) {
                        if (properties.scale) {
                            const scaleValue = 0.7 * properties.scale.value / 100;
                            model.scale.set(scaleValue);
                            // 스케일 변경 시에도 중심 위치 재조정
                            model.updateTransform();
                            model.x = (innerWidth / 2) - (model.width / 2);
                            model.y = (innerHeight / 2) - (model.height / 2);
                        }
                        if (properties.posx) {
                            model.x = (properties.posx.value * innerWidth / 100) - (model.width / 2);
                        }
                        if (properties.posy) {
                            model.y = (properties.posy.value * innerHeight / 100) - (model.height / 2);
                        }
                    }
                };

                model.on("hit", (hitAreas) => {
                    if (hitAreas.includes("Body")) {
                        model.motion("TapBody");
                    }
                    if (hitAreas.includes("Face")) {
                        model.motion("TapFace");
                    }
                });
            } catch (error) {
                console.error("모델 로드 중 오류 발생:", error);
            }
        })();
    </script>
</body>
</html>
